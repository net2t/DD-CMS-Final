<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DD-CMS · Profiles</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:       #08090d;
      --surface:  #0d0f18;
      --card:     #0f1120;
      --border:   #1a1e30;
      --border2:  #252940;
      --accent:   #00e5ff;
      --accent2:  #ff3e6c;
      --green:    #00ff88;
      --yellow:   #ffc400;
      --purple:   #b06bff;
      --text:     #c8d0e0;
      --dim:      #4a5068;
      --dim2:     #6b7290;
      --mono:     'Share Tech Mono', monospace;
      --ui:       'Rajdhani', sans-serif;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--ui);
      min-height: 100vh;
    }

    /* scanlines */
    body::before {
      content: '';
      position: fixed; inset: 0; z-index: 999; pointer-events: none;
      background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.06) 2px, rgba(0,0,0,0.06) 4px);
    }

    /* ── TOP BAR ── */
    .topbar {
      position: sticky; top: 0; z-index: 50;
      background: rgba(8,9,13,0.92);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      display: flex; align-items: center; justify-content: space-between;
      height: 56px;
      gap: 16px;
    }

    .brand {
      display: flex; align-items: center; gap: 12px; flex-shrink: 0;
    }
    .brand-icon {
      width: 34px; height: 34px; border: 1.5px solid var(--accent); border-radius: 6px;
      display: grid; place-items: center;
      font-family: var(--mono); font-size: 13px; color: var(--accent);
      box-shadow: 0 0 10px rgba(0,229,255,0.2);
    }
    .brand-name {
      font-size: 16px; font-weight: 700; letter-spacing: 3px; color: #fff; text-transform: uppercase;
    }
    .brand-ver {
      font-family: var(--mono); font-size: 10px; color: var(--dim); letter-spacing: 1px;
    }

    .topbar-center {
      flex: 1; max-width: 420px;
    }

    .search-wrap {
      position: relative;
    }
    .search-wrap input {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 8px;
      padding: 8px 14px 8px 36px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text);
      outline: none;
      transition: border-color 0.2s;
    }
    .search-wrap input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,229,255,0.08); }
    .search-wrap input::placeholder { color: var(--dim); }
    .search-icon {
      position: absolute; left: 11px; top: 50%; transform: translateY(-50%);
      color: var(--dim); font-size: 13px; pointer-events: none;
    }

    .topbar-right {
      display: flex; align-items: center; gap: 10px; flex-shrink: 0;
    }

    .live-pill {
      display: flex; align-items: center; gap: 6px;
      font-family: var(--mono); font-size: 10px; color: var(--green);
      background: rgba(0,255,136,0.08); border: 1px solid rgba(0,255,136,0.2);
      border-radius: 20px; padding: 5px 12px;
    }
    .live-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); box-shadow: 0 0 6px var(--green); animation: blink 1.4s step-start infinite; }
    @keyframes blink { 50% { opacity: 0.2; } }

    .btn {
      font-family: var(--ui); font-size: 12px; font-weight: 600; letter-spacing: 1px;
      text-transform: uppercase; padding: 7px 16px; border-radius: 6px;
      cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 6px;
      transition: all 0.2s; border: none;
    }
    .btn-ghost { background: transparent; border: 1px solid var(--border2); color: var(--dim2); }
    .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
    .btn-accent { background: rgba(0,229,255,0.1); border: 1px solid var(--accent); color: var(--accent); }
    .btn-accent:hover { background: rgba(0,229,255,0.18); }

    /* ── STATS ROW ── */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0;
      border-bottom: 1px solid var(--border);
    }
    .stat {
      padding: 18px 22px;
      border-right: 1px solid var(--border);
      position: relative;
    }
    .stat:last-child { border-right: none; }
    .stat-label {
      font-family: var(--mono); font-size: 9px; letter-spacing: 2px;
      color: var(--dim); text-transform: uppercase; margin-bottom: 6px;
    }
    .stat-val {
      font-size: 26px; font-weight: 700; line-height: 1; color: #fff; letter-spacing: -1px;
    }
    .stat-sub { font-family: var(--mono); font-size: 9px; color: var(--dim); margin-top: 4px; }

    /* ── FILTERS ── */
    .filters {
      padding: 12px 24px;
      display: flex; align-items: center; gap: 10px;
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      flex-wrap: wrap;
    }
    .filter-label { font-family: var(--mono); font-size: 10px; color: var(--dim); letter-spacing: 1px; flex-shrink: 0; }

    .filter-btn {
      font-family: var(--mono); font-size: 10px; letter-spacing: 1px; text-transform: uppercase;
      padding: 5px 12px; border-radius: 4px; cursor: pointer; transition: all 0.15s;
      border: 1px solid var(--border2); background: transparent; color: var(--dim2);
      flex-shrink: 0;
    }
    .filter-btn.active, .filter-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(0,229,255,0.07); }
    .filter-btn.f-female.active { border-color: var(--accent2); color: var(--accent2); background: rgba(255,62,108,0.07); }
    .filter-btn.f-male.active   { border-color: #4fc3f7; color: #4fc3f7; background: rgba(79,195,247,0.07); }

    .sort-select {
      font-family: var(--mono); font-size: 10px; letter-spacing: 1px;
      background: var(--surface); border: 1px solid var(--border2); color: var(--dim2);
      border-radius: 4px; padding: 5px 10px; cursor: pointer; outline: none;
      margin-left: auto; flex-shrink: 0;
    }
    .sort-select:focus { border-color: var(--accent); }

    /* ── MAIN LAYOUT ── */
    .main { padding: 0; }

    /* ── PROFILE GRID ── */
    #profile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 1px;
      background: var(--border);
    }

    .profile-card {
      background: var(--card);
      padding: 18px;
      cursor: pointer;
      transition: background 0.15s;
      position: relative;
      overflow: hidden;
    }
    .profile-card:hover { background: #121525; }

    .profile-card::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; height: 2px;
      background: var(--card-top, transparent);
      transition: opacity 0.2s;
    }
    .profile-card:hover::before { opacity: 1; }

    .card-top {
      display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;
    }

    .avatar {
      width: 46px; height: 46px; border-radius: 8px;
      object-fit: cover; flex-shrink: 0;
      background: var(--surface);
      border: 1px solid var(--border2);
    }
    .avatar-placeholder {
      width: 46px; height: 46px; border-radius: 8px; flex-shrink: 0;
      background: var(--surface); border: 1px solid var(--border2);
      display: grid; place-items: center;
      font-family: var(--mono); font-size: 16px; color: var(--dim);
    }

    .card-info { flex: 1; min-width: 0; }
    .card-nick {
      font-size: 15px; font-weight: 700; color: #fff; letter-spacing: 0.5px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .card-city {
      font-family: var(--mono); font-size: 10px; color: var(--dim); letter-spacing: 1px; margin-top: 2px;
    }

    .card-badge {
      font-family: var(--mono); font-size: 9px; letter-spacing: 1px;
      padding: 3px 7px; border-radius: 3px; text-transform: uppercase; flex-shrink: 0;
    }
    .badge-f { background: rgba(255,62,108,0.12); color: var(--accent2); border: 1px solid rgba(255,62,108,0.25); }
    .badge-m { background: rgba(79,195,247,0.1);  color: #4fc3f7;        border: 1px solid rgba(79,195,247,0.25); }
    .badge-u { background: rgba(74,80,104,0.2);   color: var(--dim);     border: 1px solid var(--border2); }

    .card-stats {
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px;
    }
    .cs { text-align: center; }
    .cs-val { font-size: 13px; font-weight: 700; color: #fff; }
    .cs-key { font-family: var(--mono); font-size: 9px; color: var(--dim); letter-spacing: 1px; margin-top: 1px; }

    .card-footer {
      margin-top: 10px; padding-top: 10px;
      border-top: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .card-ts { font-family: var(--mono); font-size: 9px; color: var(--dim); }
    .card-phase {
      font-family: var(--mono); font-size: 9px; letter-spacing: 1px; padding: 2px 7px; border-radius: 3px;
    }
    .phase-ready { background: rgba(0,255,136,0.1); color: var(--green); border: 1px solid rgba(0,255,136,0.2); }
    .phase-no    { background: rgba(74,80,104,0.2); color: var(--dim);   border: 1px solid var(--border2); }

    .rank-star { height: 14px; vertical-align: middle; margin-right: 4px; }

    /* ── EMPTY / LOADING ── */
    #loading-state {
      padding: 80px 24px; text-align: center;
    }
    .spinner {
      width: 40px; height: 40px; border-radius: 50%;
      border: 2px solid var(--border2); border-top-color: var(--accent);
      animation: spin 0.8s linear infinite; margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { font-family: var(--mono); font-size: 12px; color: var(--dim); letter-spacing: 2px; }

    #error-state {
      padding: 60px 24px; text-align: center; display: none;
    }
    .error-icon { font-size: 32px; margin-bottom: 12px; }
    .error-title { font-size: 18px; font-weight: 700; color: var(--accent2); margin-bottom: 8px; }
    .error-msg { font-family: var(--mono); font-size: 11px; color: var(--dim); max-width: 460px; margin: 0 auto 20px; line-height: 1.7; }

    #empty-state { padding: 60px 24px; text-align: center; display: none; }
    .empty-text { font-family: var(--mono); font-size: 12px; color: var(--dim); }

    /* ── DETAIL DRAWER ── */
    .drawer-overlay {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
      display: none; align-items: flex-start; justify-content: flex-end;
    }
    .drawer-overlay.open { display: flex; }

    .drawer {
      width: 400px; max-width: 100vw; height: 100vh;
      background: var(--surface); border-left: 1px solid var(--border2);
      overflow-y: auto; padding: 0;
      animation: slide-in 0.2s ease;
    }
    @keyframes slide-in { from { transform: translateX(100%); } to { transform: translateX(0); } }

    .drawer-header {
      padding: 20px 20px 16px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; background: var(--surface); z-index: 1;
    }
    .drawer-nick { font-size: 20px; font-weight: 700; color: #fff; }
    .drawer-close {
      width: 32px; height: 32px; border-radius: 6px;
      background: transparent; border: 1px solid var(--border2);
      color: var(--dim2); cursor: pointer; display: grid; place-items: center;
      font-size: 16px; transition: all 0.15s;
    }
    .drawer-close:hover { border-color: var(--accent2); color: var(--accent2); }

    .drawer-avatar-row {
      padding: 20px; display: flex; align-items: center; gap: 16px;
    }
    .drawer-avatar {
      width: 72px; height: 72px; border-radius: 10px; object-fit: cover;
      border: 2px solid var(--border2); background: var(--card); flex-shrink: 0;
    }
    .drawer-avatar-ph {
      width: 72px; height: 72px; border-radius: 10px; flex-shrink: 0;
      background: var(--card); border: 2px solid var(--border2);
      display: grid; place-items: center; font-size: 28px; color: var(--dim);
    }

    .drawer-section { padding: 0 20px 16px; }
    .drawer-section-title {
      font-family: var(--mono); font-size: 9px; letter-spacing: 3px; color: var(--dim);
      text-transform: uppercase; margin-bottom: 10px;
      padding-bottom: 6px; border-bottom: 1px solid var(--border);
    }

    .drawer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .drawer-field { }
    .df-key { font-family: var(--mono); font-size: 9px; color: var(--dim); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 3px; }
    .df-val { font-size: 14px; font-weight: 600; color: var(--text); word-break: break-all; }
    .df-val a { color: var(--accent); text-decoration: none; }
    .df-val a:hover { text-decoration: underline; }
    .df-val.full { grid-column: 1/-1; }

    .drawer-actions {
      padding: 16px 20px; display: flex; gap: 10px;
      border-top: 1px solid var(--border);
      position: sticky; bottom: 0; background: var(--surface);
    }

    /* ── PAGINATION / COUNT ── */
    .table-footer {
      padding: 14px 24px;
      border-top: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      font-family: var(--mono); font-size: 11px; color: var(--dim);
    }

    /* ── RESPONSIVE ── */
    @media (max-width: 700px) {
      .stats-row { grid-template-columns: repeat(3, 1fr); }
      .stat:nth-child(4), .stat:nth-child(5) { border-top: 1px solid var(--border); }
      .topbar-center { display: none; }
      #profile-grid { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 440px) {
      #profile-grid { grid-template-columns: 1fr; }
      .stats-row { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="brand">
    <div class="brand-icon">DD</div>
    <div>
      <div class="brand-name">DD-CMS</div>
      <div class="brand-ver">PROFILES DASHBOARD</div>
    </div>
  </div>
  <div class="topbar-center">
    <div class="search-wrap">
      <span class="search-icon">⌕</span>
      <input type="text" id="search-input" placeholder="Search nickname, city, tags...">
    </div>
  </div>
  <div class="topbar-right">
    <div class="live-pill"><div class="live-dot"></div> LIVE</div>
    <a href="https://github.com/net2t/DD-CMS-Final" target="_blank" class="btn btn-ghost">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
      GitHub
    </a>
    <button class="btn btn-accent" onclick="loadData()">↺ Refresh</button>
  </div>
</div>

<!-- STATS ROW -->
<div class="stats-row">
  <div class="stat">
    <div class="stat-label">Total Profiles</div>
    <div class="stat-val" id="s-total">—</div>
    <div class="stat-sub">in Profiles sheet</div>
  </div>
  <div class="stat">
    <div class="stat-label">Female</div>
    <div class="stat-val" id="s-female" style="color:var(--accent2)">—</div>
    <div class="stat-sub" id="s-female-pct"></div>
  </div>
  <div class="stat">
    <div class="stat-label">Male</div>
    <div class="stat-val" id="s-male" style="color:#4fc3f7">—</div>
    <div class="stat-sub" id="s-male-pct"></div>
  </div>
  <div class="stat">
    <div class="stat-label">Phase 2 Ready</div>
    <div class="stat-val" id="s-phase2" style="color:var(--green)">—</div>
    <div class="stat-sub">posts &lt; 100</div>
  </div>
  <div class="stat">
    <div class="stat-label">Last Scraped</div>
    <div class="stat-val" id="s-last" style="font-size:14px; padding-top:6px">—</div>
    <div class="stat-sub" id="s-last-nick"></div>
  </div>
</div>

<!-- FILTERS -->
<div class="filters">
  <span class="filter-label">FILTER:</span>
  <button class="filter-btn active" data-filter="all">All</button>
  <button class="filter-btn f-female" data-filter="female">Female</button>
  <button class="filter-btn f-male"   data-filter="male">Male</button>
  <button class="filter-btn" data-filter="phase2">Phase 2 Ready</button>
  <button class="filter-btn" data-filter="karachi">Karachi</button>
  <button class="filter-btn" data-filter="lahore">Lahore</button>
  <button class="filter-btn" data-filter="islamabad">Islamabad</button>
  <select class="sort-select" id="sort-select">
    <option value="date">Sort: Recent First</option>
    <option value="followers">Sort: Followers</option>
    <option value="posts">Sort: Posts</option>
    <option value="nick">Sort: A–Z</option>
  </select>
</div>

<!-- MAIN -->
<div class="main">
  <div id="loading-state">
    <div class="spinner"></div>
    <div class="loading-text">FETCHING SHEET DATA...</div>
    <div style="font-family:var(--mono);font-size:10px;color:var(--dim);margin-top:10px;" id="loading-hint"></div>
  </div>

  <div id="error-state">
    <div class="error-icon">⚠</div>
    <div class="error-title">Cannot Load Sheet</div>
    <div class="error-msg" id="error-msg"></div>
    <button class="btn btn-accent" onclick="loadData()">Try Again</button>
  </div>

  <div id="empty-state">
    <div class="empty-text">NO PROFILES MATCH YOUR FILTER</div>
  </div>

  <div id="profile-grid"></div>

  <div class="table-footer" id="table-footer" style="display:none">
    <span id="footer-count"></span>
    <span id="footer-updated"></span>
  </div>
</div>

<!-- DETAIL DRAWER -->
<div class="drawer-overlay" id="drawer-overlay" onclick="closeDrawer(event)">
  <div class="drawer" id="drawer">
    <div class="drawer-header">
      <div class="drawer-nick" id="d-nick">—</div>
      <button class="drawer-close" onclick="closeDrawerDirect()">✕</button>
    </div>
    <div class="drawer-avatar-row">
      <div id="d-avatar-wrap"></div>
      <div>
        <div style="font-family:var(--mono);font-size:10px;color:var(--dim);letter-spacing:1px;margin-bottom:4px">STATUS</div>
        <div id="d-status" style="font-size:15px;font-weight:700;color:var(--green)"></div>
        <div id="d-tags" style="margin-top:6px;font-family:var(--mono);font-size:10px;color:var(--purple)"></div>
      </div>
    </div>
    <div class="drawer-section">
      <div class="drawer-section-title">Profile Info</div>
      <div class="drawer-grid" id="d-info"></div>
    </div>
    <div class="drawer-section">
      <div class="drawer-section-title">Stats</div>
      <div class="drawer-grid" id="d-stats"></div>
    </div>
    <div class="drawer-section" id="d-meh-section">
      <div class="drawer-section-title">Mehfils</div>
      <div id="d-meh"></div>
    </div>
    <div class="drawer-actions">
      <a id="d-link-profile" href="#" target="_blank" class="btn btn-accent" style="flex:1;justify-content:center">View Profile</a>
      <a id="d-link-posts"   href="#" target="_blank" class="btn btn-ghost"  style="flex:1;justify-content:center">View Posts</a>
    </div>
  </div>
</div>

<script>
// ── CONFIG ──
// IMPORTANT: Replace SHEET_ID with your actual Google Sheet ID
// Get it from your sheet URL: docs.google.com/spreadsheets/d/SHEET_ID/edit
const SHEET_ID  = '16t-D8dCXFvheHEpncoQ_VnXQKkrEREAup7c1ZLFXvu0';
const SHEET_TAB = 'Profiles'; // must match sheet tab name exactly

// Column indices (0-based) — matches COLUMN_ORDER in config_common.py
const C = {
  ID:         0,  NICK:    1,  TAGS:     2,  CITY:      3,
  GENDER:     4,  MARRIED: 5,  AGE:      6,  JOINED:    7,
  FOLLOWERS:  8,  STATUS:  9,  POSTS:   10,  SKIP:     11,
  DATETIME:  12,  LASTPOST:13, LASTTIME:14,  IMAGE:    15,
  PROFILELINK:16, POSTURL: 17, RURL:    18,  MEHNAME:  19,
  MEHLINK:   20,  MEHDATE: 21, PHASE2:  22
};

// ── STATE ──
let allProfiles = [];
let filtered    = [];
let activeFilter = 'all';
let searchQuery  = '';
let sortBy       = 'date';
let lastFetch    = null;

// ── FETCH ──
async function loadData() {
  show('loading-state');
  hide('error-state'); hide('empty-state'); hide('table-footer');
  document.getElementById('profile-grid').innerHTML = '';

  // Check if Sheet ID is configured
  if (SHEET_ID === 'YOUR_SHEET_ID_HERE') {
    showError(
      'Sheet ID not configured.\n\n' +
      'Open docs/index.html and replace YOUR_SHEET_ID_HERE with your Google Sheet ID.\n\n' +
      'Your Sheet ID is in the URL:\ndocs.google.com/spreadsheets/d/[SHEET_ID]/edit\n\n' +
      'Also make sure your sheet is set to "Anyone with link can view".'
    );
    return;
  }

  document.getElementById('loading-hint').textContent =
    'Make sure your Google Sheet is set to "Anyone with link → Viewer"';

  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_TAB)}`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();

    // gviz response is wrapped: google.visualization.Query.setResponse({...})
    const json = JSON.parse(text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\)/)[1]);

    if (json.status === 'error') {
      throw new Error(json.errors?.[0]?.detailed_message || 'Sheet API error');
    }

    const rows = json.table?.rows || [];
    allProfiles = rows
      .slice(1) // skip header row
      .map(r => (r.c || []).map(c => c ? (c.v ?? c.f ?? '') : ''))
      .filter(r => r[C.NICK] && String(r[C.NICK]).trim());

    lastFetch = new Date();
    buildStats();
    applyFilters();
    hide('loading-state');
    show('table-footer');

  } catch (err) {
    showError(
      `Failed to load sheet data.\n\nError: ${err.message}\n\n` +
      `Make sure:\n1. Your sheet is public (Share → Anyone with link → Viewer)\n` +
      `2. The SHEET_ID in index.html matches your sheet\n` +
      `3. The tab is named exactly "Profiles"`
    );
  }
}

// ── STATS ──
function buildStats() {
  const total   = allProfiles.length;
  const females = allProfiles.filter(r => String(r[C.GENDER]).toUpperCase() === 'FEMALE').length;
  const males   = allProfiles.filter(r => String(r[C.GENDER]).toUpperCase() === 'MALE').length;
  const phase2  = allProfiles.filter(r => String(r[C.PHASE2]).toLowerCase().includes('ready')).length;
  const last    = allProfiles[0];

  document.getElementById('s-total').textContent  = total.toLocaleString();
  document.getElementById('s-female').textContent = females.toLocaleString();
  document.getElementById('s-male').textContent   = males.toLocaleString();
  document.getElementById('s-phase2').textContent = phase2.toLocaleString();
  document.getElementById('s-female-pct').textContent = total ? Math.round(females/total*100)+'%' : '';
  document.getElementById('s-male-pct').textContent   = total ? Math.round(males/total*100)+'%' : '';

  if (last) {
    document.getElementById('s-last').textContent      = String(last[C.DATETIME]).split(' ').slice(0,2).join(' ');
    document.getElementById('s-last-nick').textContent = String(last[C.NICK]);
  }
}

// ── FILTER + SORT ──
function applyFilters() {
  const q = searchQuery.toLowerCase();

  filtered = allProfiles.filter(r => {
    const nick   = String(r[C.NICK]  || '').toLowerCase();
    const city   = String(r[C.CITY]  || '').toLowerCase();
    const tags   = String(r[C.TAGS]  || '').toLowerCase();
    const gender = String(r[C.GENDER]|| '').toUpperCase();
    const phase  = String(r[C.PHASE2]|| '').toLowerCase();

    // search
    if (q && !nick.includes(q) && !city.includes(q) && !tags.includes(q)) return false;

    // filter
    if (activeFilter === 'female'    && gender !== 'FEMALE')             return false;
    if (activeFilter === 'male'      && gender !== 'MALE')               return false;
    if (activeFilter === 'phase2'    && !phase.includes('ready'))        return false;
    if (activeFilter === 'karachi'   && !city.includes('karachi'))       return false;
    if (activeFilter === 'lahore'    && !city.includes('lahore'))        return false;
    if (activeFilter === 'islamabad' && !city.includes('islamabad'))     return false;

    return true;
  });

  // sort
  filtered.sort((a, b) => {
    if (sortBy === 'followers') return (parseInt(b[C.FOLLOWERS])||0) - (parseInt(a[C.FOLLOWERS])||0);
    if (sortBy === 'posts')     return (parseInt(b[C.POSTS]    )||0) - (parseInt(a[C.POSTS]    )||0);
    if (sortBy === 'nick')      return String(a[C.NICK]).localeCompare(String(b[C.NICK]));
    return 0; // date = sheet order (already sorted by scrape date)
  });

  renderGrid();
}

// ── RENDER ──
function renderGrid() {
  const grid = document.getElementById('profile-grid');
  grid.innerHTML = '';

  if (!filtered.length) { show('empty-state'); return; }
  hide('empty-state');

  const frag = document.createDocumentFragment();
  filtered.forEach((r, i) => {
    frag.appendChild(makeCard(r, i));
  });
  grid.appendChild(frag);

  document.getElementById('footer-count').textContent =
    `Showing ${filtered.length.toLocaleString()} of ${allProfiles.length.toLocaleString()} profiles`;
  document.getElementById('footer-updated').textContent =
    lastFetch ? `Last fetched: ${lastFetch.toLocaleTimeString()}` : '';
}

function makeCard(r, idx) {
  const div   = document.createElement('div');
  const nick  = String(r[C.NICK]  || '—');
  const city  = String(r[C.CITY]  || '');
  const gender= String(r[C.GENDER]|| '').toUpperCase();
  const age   = String(r[C.AGE]   || '');
  const followers = fmt(r[C.FOLLOWERS]);
  const posts     = fmt(r[C.POSTS]);
  const phase2    = String(r[C.PHASE2]|| '');
  const dt        = String(r[C.DATETIME]|| '');
  const img       = String(r[C.IMAGE]  || '');
  const rurl      = String(r[C.RURL]   || '');

  const genderBadge = gender === 'FEMALE'
    ? '<span class="card-badge badge-f">F</span>'
    : gender === 'MALE'
    ? '<span class="card-badge badge-m">M</span>'
    : '<span class="card-badge badge-u">?</span>';

  const topColor = gender === 'FEMALE' ? 'var(--accent2)' : gender === 'MALE' ? '#4fc3f7' : 'var(--dim)';

  const avatarHtml = img
    ? `<img class="avatar" src="${escHtml(img)}" alt="${escHtml(nick)}" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='grid'">`
      + `<div class="avatar-placeholder" style="display:none">${nick[0]?.toUpperCase()||'?'}</div>`
    : `<div class="avatar-placeholder">${nick[0]?.toUpperCase()||'?'}</div>`;

  const rankImg = rurl
    ? `<img class="rank-star" src="${escHtml(rurl)}" alt="rank" onerror="this.style.display='none'">` : '';

  const phaseHtml = phase2.toLowerCase().includes('ready')
    ? '<span class="card-phase phase-ready">P2 Ready</span>'
    : '';

  div.className = 'profile-card';
  div.style.setProperty('--card-top', topColor);
  div.innerHTML = `
    <div class="card-top">
      <div style="position:relative;flex-shrink:0">${avatarHtml}</div>
      <div class="card-info">
        <div class="card-nick">${rankImg}${escHtml(nick)}</div>
        <div class="card-city">${escHtml(city) || '&nbsp;'}${age ? ' · ' + escHtml(age) + 'y' : ''}</div>
      </div>
      ${genderBadge}
    </div>
    <div class="card-stats">
      <div class="cs"><div class="cs-val">${followers}</div><div class="cs-key">Followers</div></div>
      <div class="cs"><div class="cs-val">${posts}</div><div class="cs-key">Posts</div></div>
      <div class="cs"><div class="cs-val">${String(r[C.MARRIED]||'—')}</div><div class="cs-key">Married</div></div>
    </div>
    <div class="card-footer">
      <div class="card-ts">${dt.split(' ').slice(0,2).join(' ')}</div>
      ${phaseHtml}
    </div>
  `;
  div.addEventListener('click', () => openDrawer(r));
  return div;
}

// ── DRAWER ──
function openDrawer(r) {
  const nick     = String(r[C.NICK]   || '—');
  const img      = String(r[C.IMAGE]  || '');
  const status   = String(r[C.STATUS] || '');
  const tags     = String(r[C.TAGS]   || '');
  const profLink = String(r[C.PROFILELINK]|| '');
  const postUrl  = String(r[C.POSTURL]    || '');
  const mehName  = String(r[C.MEHNAME]    || '');
  const mehLink  = String(r[C.MEHLINK]    || '');
  const mehDate  = String(r[C.MEHDATE]    || '');
  const rurl     = String(r[C.RURL]       || '');

  document.getElementById('d-nick').textContent = nick;
  document.getElementById('d-status').textContent = status || '—';
  document.getElementById('d-tags').textContent = tags ? '# ' + tags : '';

  // avatar
  const avatarWrap = document.getElementById('d-avatar-wrap');
  avatarWrap.innerHTML = img
    ? `<img class="drawer-avatar" src="${escHtml(img)}" alt="${escHtml(nick)}" onerror="this.outerHTML='<div class=drawer-avatar-ph>${nick[0]?.toUpperCase()||'?'}</div>'">`
    : `<div class="drawer-avatar-ph">${nick[0]?.toUpperCase()||'?'}</div>`;

  // info
  document.getElementById('d-info').innerHTML = field('City',    r[C.CITY])
    + field('Gender',  r[C.GENDER]) + field('Age', r[C.AGE])
    + field('Married', r[C.MARRIED])+ field('Joined', r[C.JOINED])
    + field('Mode',    r[C.SKIP])   + field('Scraped', r[C.DATETIME], true)
    + (rurl ? `<div class="drawer-field"><div class="df-key">Rank</div><div class="df-val"><img src="${escHtml(rurl)}" style="height:16px" alt="rank"></div></div>` : '');

  // stats
  document.getElementById('d-stats').innerHTML =
    field('Followers', r[C.FOLLOWERS]) + field('Posts', r[C.POSTS])
    + field('Phase 2',  r[C.PHASE2])   + field('Last Post', r[C.LASTTIME])
    + (r[C.LASTPOST] ? `<div class="drawer-field df-val full"><div class="df-key">Last Post URL</div><div class="df-val"><a href="${escHtml(String(r[C.LASTPOST]))}" target="_blank">View Post ↗</a></div></div>` : '');

  // mehfils
  const mehSection = document.getElementById('d-meh-section');
  const mehDiv     = document.getElementById('d-meh');
  if (mehName) {
    mehSection.style.display = '';
    const names = mehName.split('\n');
    const links = mehLink.split('\n');
    const dates = mehDate.split('\n');
    mehDiv.innerHTML = names.map((n, i) => `
      <div style="padding:8px 0;border-bottom:1px solid var(--border);font-size:13px;color:var(--text)">
        ${links[i] ? `<a href="${escHtml(links[i])}" target="_blank" style="color:var(--accent);text-decoration:none">${escHtml(n)}</a>` : escHtml(n)}
        ${dates[i] ? `<span style="font-family:var(--mono);font-size:9px;color:var(--dim);margin-left:8px">${escHtml(dates[i])}</span>` : ''}
      </div>`).join('');
  } else {
    mehSection.style.display = 'none';
  }

  document.getElementById('d-link-profile').href = profLink || '#';
  document.getElementById('d-link-posts').href   = postUrl  || '#';

  document.getElementById('drawer-overlay').classList.add('open');
}

function field(key, val, full) {
  val = String(val || '—');
  return `<div class="drawer-field${full?' df-val full':''}">
    <div class="df-key">${key}</div>
    <div class="df-val">${escHtml(val)}</div>
  </div>`;
}

function closeDrawer(e) {
  if (e.target === document.getElementById('drawer-overlay')) closeDrawerDirect();
}
function closeDrawerDirect() {
  document.getElementById('drawer-overlay').classList.remove('open');
}

// ── HELPERS ──
function show(id) { document.getElementById(id).style.display = ''; }
function hide(id) { document.getElementById(id).style.display = 'none'; }
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function fmt(v) {
  const n = parseInt(String(v || '').replace(/\D/g, ''));
  if (isNaN(n)) return '—';
  if (n >= 1000) return (n/1000).toFixed(1) + 'k';
  return String(n);
}
function showError(msg) {
  hide('loading-state');
  document.getElementById('error-msg').innerText = msg;
  show('error-state');
}

// ── EVENTS ──
document.getElementById('search-input').addEventListener('input', e => {
  searchQuery = e.target.value.trim();
  applyFilters();
});

document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    activeFilter = btn.dataset.filter;
    applyFilters();
  });
});

document.getElementById('sort-select').addEventListener('change', e => {
  sortBy = e.target.value;
  applyFilters();
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeDrawerDirect();
});

// ── INIT ──
loadData();
</script>
</body>
</html>
